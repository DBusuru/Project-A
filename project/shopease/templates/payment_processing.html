{% extends 'base.html' %}

{% block content %}
<div class="section">
    <div class="container">
        <div class="row">
            <div class="col-md-6 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h3>M-Pesa Payment</h3>
                    </div>
                    <div class="card-body">
                        <div class="payment-details mb-4">
                            <h4>Payment Details</h4>
                            <p>Order #: {{ order.id }}</p>
                            <p>Amount to Pay: KES {{ amount|floatformat:2 }}</p>
                            <p>Payment Type: {{ order.payment_plan|title }}</p>
                        </div>

                        <form id="payment-form">
                            {% csrf_token %}
                            <div class="form-group">
                                <label>M-Pesa Phone Number</label>
                                <input type="text" id="phone_number" class="input" 
                                       placeholder="e.g., 0712345678" required>
                                <small class="form-text text-muted">
                                    Enter the M-Pesa number you want to use for payment
                                </small>
                            </div>
                            
                            <button type="submit" class="primary-btn btn-block mt-4">
                                Pay with M-Pesa
                            </button>
                            
                            <div id="payment-status" class="mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="fa fa-spinner fa-spin"></i>
                                    Please check your phone to complete the payment...
                                </div>
                            </div>
                        </form>

                        <div class="payment-instructions mt-4">
                            <h5>How to Pay:</h5>
                            <ol>
                                <li>Enter your M-Pesa phone number</li>
                                <li>Click "Pay with M-Pesa"</li>
                                <li>You will receive a prompt on your phone</li>
                                <li>Enter your M-Pesa PIN to complete payment</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('payment-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const phoneNumber = document.getElementById('phone_number').value;
    const paymentStatus = document.getElementById('payment-status');
    const submitButton = this.querySelector('button[type="submit"]');
    
    // Disable submit button and show status
    submitButton.disabled = true;
    paymentStatus.style.display = 'block';
    
    // Send payment request
    fetch("{% url 'shopease:initiate_payment' order.id %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            phone_number: phoneNumber
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Start polling for payment status
            pollPaymentStatus(data.checkout_request_id);
        } else {
            showError(data.error);
            submitButton.disabled = false;
        }
    })
    .catch(error => {
        showError('An error occurred. Please try again.');
        submitButton.disabled = false;
    });
});

function pollPaymentStatus(checkoutRequestId) {
    const interval = setInterval(() => {
        fetch(`{% url 'shopease:check_payment_status' %}?checkout_request_id=${checkoutRequestId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'completed') {
                    clearInterval(interval);
                    window.location.href = "{% url 'shopease:order_confirmation' order.id %}";
                } else if (data.status === 'failed') {
                    clearInterval(interval);
                    showError('Payment failed. Please try again.');
                    document.querySelector('button[type="submit"]').disabled = false;
                }
            });
    }, 5000); // Poll every 5 seconds
}

function showError(message) {
    const paymentStatus = document.getElementById('payment-status');
    paymentStatus.innerHTML = `<div class="alert alert-danger">${message}</div>`;
    paymentStatus.style.display = 'block';
}
</script>
{% endblock %}